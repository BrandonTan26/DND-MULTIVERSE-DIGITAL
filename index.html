<script>
  // =========================
  //  KONFIG UTAMA
  // =========================
  const DEFAULT_WA = "6287809236556";

  // === DATA VARIAN PRODUK (TANPA GOOGLE SHEET) ===
  // 1 row = 1 varian yang muncul di modal
  const STATIC_VARIANTS = [
    {
      id: 1,
      nama: "YouTube Premium Family 1 Bulan",
      harga: 9000,
      harga_lama: 49000,
      ikon: "https://www.logo.wine/a/logo/YouTube/YouTube-Logo.wine.svg",
      deskripsi: [
        "Akses akun utama + anggota keluarga",
        "Tanpa iklan di semua device",
        "Bisa download & background play"
      ],
      kategori: "Langganan",
      stok: 99,
      kode: "YT-FAM-1",
      group: "YouTube Premium",
      wa: DEFAULT_WA
    },
    {
      id: 2,
      nama: "YouTube Premium Family 2 Bulan",
      harga: 17000,
      harga_lama: 98000,
      ikon: "https://www.logo.wine/a/logo/YouTube/YouTube-Logo.wine.svg",
      deskripsi: [
        "Masa aktif 2 bulan",
        "Garansi full selama masa langganan",
        "Support semua device yang didukung YouTube"
      ],
      kategori: "Langganan",
      stok: 99,
      kode: "YT-FAM-2",
      group: "YouTube Premium",
      wa: DEFAULT_WA
    },
    {
      id: 3,
      nama: "Apple Music Individual 1 Bulan",
      harga: 10000,
      harga_lama: 49999,
      ikon: "https://upload.wikimedia.org/wikipedia/commons/d/d9/ITunes_12.2_logo.png",
      deskripsi: [
        "Full akses katalog Apple Music",
        "Support iOS, Android, dan desktop",
        "Kualitas audio tinggi"
      ],
      kategori: "Langganan",
      stok: 99,
      kode: "AM-IND-1",
      group: "Apple Music",
      wa: DEFAULT_WA
    },
    {
      id: 4,
      nama: "Netflix Premium 1 Bulan",
      harga: 21000,
      harga_lama: 120000,
      ikon: "https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg",
      deskripsi: [
        "Resolusi sampai 4K (sesuai device)",
        "Profil sharing sesuai paket",
        "Banyak pilihan film & series"
      ],
      kategori: "Streaming",
      stok: 99,
      kode: "NF-PREM-1",
      group: "Netflix Premium",
      wa: DEFAULT_WA
    },
    {
      id: 5,
      nama: "Netflix Premium Slot 1 Bulan",
      harga: 15000,
      harga_lama: 70000,
      ikon: "https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg",
      deskripsi: [
        "Sistem slot di akun premium",
        "1 slot 1 profil",
        "Cocok untuk pemakaian pribadi"
      ],
      kategori: "Streaming",
      stok: 99,
      kode: "NF-SLOT-1",
      group: "Netflix Premium",
      wa: DEFAULT_WA
    },
    {
      id: 6,
      nama: "Canva Pro 1 Bulan",
      harga: 3000,
      harga_lama: 95000,
      ikon: "https://upload.wikimedia.org/wikipedia/commons/3/3b/Canva_Logo.png",
      deskripsi: [
        "Akses semua template & asset Pro",
        "Cocok untuk jualan & konten harian",
        "Bisa di HP dan laptop"
      ],
      kategori: "Desain",
      stok: 99,
      kode: "CV-PRO-1",
      group: "Canva Premium",
      wa: DEFAULT_WA
    },
    {
      id: 7,
      nama: "Canva Pro 1 Tahun",
      harga: 18000,
      harga_lama: 500000,
      ikon: "https://upload.wikimedia.org/wikipedia/commons/3/3b/Canva_Logo.png",
      deskripsi: [
        "Masa aktif 12 bulan",
        "Free update fitur terbaru",
        "Garansi sesuai masa langganan"
      ],
      kategori: "Desain",
      stok: 99,
      kode: "CV-PRO-12",
      group: "Canva Premium",
      wa: DEFAULT_WA
    },
    {
      id: 8,
      nama: "CapCut Pro 1 Bulan",
      harga: 7000,
      harga_lama: 95000,
      ikon: "https://seeklogo.com/images/C/capcut-logo-8E50AB6A4F-seeklogo.com.png",
      deskripsi: [
        "Hilangkan watermark CapCut",
        "Semua efek & template Pro kebuka",
        "Cocok untuk konten kreator"
      ],
      kategori: "Desain",
      stok: 99,
      kode: "CC-PRO-1",
      group: "CapCut Premium",
      wa: DEFAULT_WA
    },
    {
      id: 9,
      nama: "CapCut Pro 3 Bulan",
      harga: 18000,
      harga_lama: 285000,
      ikon: "https://seeklogo.com/images/C/capcut-logo-8E50AB6A4F-seeklogo.com.png",
      deskripsi: [
        "Masa aktif 3 bulan",
        "Garansi penuh selama masa aktif",
        "Bisa di Android / iOS"
      ],
      kategori: "Desain",
      stok: 99,
      kode: "CC-PRO-3",
      group: "CapCut Premium",
      wa: DEFAULT_WA
    },
    {
      id: 10,
      nama: "ChatGPT Plus 1 Bulan",
      harga: 12000,
      harga_lama: 350000,
      ikon: "https://seeklogo.com/images/C/chatgpt-logo-02AFA704B5-seeklogo.com.png",
      deskripsi: [
        "Akses GPT canggih untuk kerja & belajar",
        "Cocok untuk copywriting, ide, dan tugas",
        "Garansi login selama masa aktif"
      ],
      kategori: "AI Tools",
      stok: 99,
      kode: "CG-PLUS-1",
      group: "ChatGPT Premium",
      wa: DEFAULT_WA
    },
    {
      id: 11,
      nama: "ChatGPT Team Slot",
      harga: 9500,
      harga_lama: 280000,
      ikon: "https://seeklogo.com/images/C/chatgpt-logo-02AFA704B5-seeklogo.com.png",
      deskripsi: [
        "Sistem slot di akun Team",
        "Performa cepat & stabil",
        "Support multi device"
      ],
      kategori: "AI Tools",
      stok: 99,
      kode: "CG-TEAM-1",
      group: "ChatGPT Premium",
      wa: DEFAULT_WA
    },
    {
      id: 12,
      nama: "WeTV Private 1 Bulan",
      harga: 28000,
      harga_lama: 59000,
      ikon: "https://upload.wikimedia.org/wikipedia/commons/1/1a/WeTV_logo.png",
      deskripsi: [
        "Akun private 1 bulan",
        "Banyak drama Asia & film",
        "Login di beberapa device"
      ],
      kategori: "Streaming",
      stok: 99,
      kode: "WETV-1",
      group: "WeTV Premium",
      wa: DEFAULT_WA
    },
    {
      id: 13,
      nama: "VIU Premium 1 Bulan",
      harga: 6000,
      harga_lama: 45000,
      ikon: "https://upload.wikimedia.org/wikipedia/commons/6/6e/Viu_logo.png",
      deskripsi: [
        "Semua konten premium terbuka",
        "Tanpa iklan yang ganggu",
        "Support Android, iOS, dan web"
      ],
      kategori: "Streaming",
      stok: 99,
      kode: "VIU-1",
      group: "VIU Premium",
      wa: DEFAULT_WA
    },
    {
      id: 14,
      nama: "Google One 2TB + Gmail Pro 1 Tahun",
      harga: 20000,
      harga_lama: 899000,
      ikon: "https://upload.wikimedia.org/wikipedia/commons/5/5f/Google_One_logo.png",
      deskripsi: [
        "Kapasitas 2TB untuk Drive, Gmail, Photos",
        "Cocok untuk backup kerja & bisnis",
        "Bisa share family group (sesuai paket)"
      ],
      kategori: "Penyimpanan",
      stok: 99,
      kode: "GONE-2TB-1Y",
      group: "Google One + Drive 2TB",
      wa: DEFAULT_WA
    }
  ];

  // =========================
  //  VAR & UTIL
  // =========================
  let produkVariants = [];
  let produkGroups   = [];
  let viewData       = [];
  let page           = 1;
  const perPage      = 12;

  const produkList   = document.getElementById("produk-list");
  const searchInput  = document.getElementById("searchInput");
  const btnLoadMore  = document.getElementById("btnLoadMore");

  const CART_KEY = "dnd_cart";
  const WISH_KEY = "dnd_wishlist";

  const categoryIconsFA = {
    "Langganan":"fa-bell",
    "Streaming":"fa-tv",
    "Penyimpanan":"fa-hard-drive",
    "Software":"fa-puzzle-piece",
    "Desain":"fa-palette",
    "Produktivitas":"fa-book",
    "AI Tools":"fa-robot",
    "Keamanan":"fa-shield-halved",
    "Game":"fa-gamepad",
    "Voucher":"fa-gift",
    "Instagram":"fa-brands fa-instagram",
    "TikTok":"fa-brands fa-tiktok"
  };

  const money = n => `Rp${(Number(n)||0).toLocaleString('id-ID')}`;
  const getStorage = (k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f;}catch{return f;}};
  const setStorage = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

  function setNavOffset(){
    const nav = document.getElementById('mainNavbar');
    if(!nav) return;
    const h = nav.offsetHeight || 64;
    document.documentElement.style.setProperty('--nav-h', h + 'px');
  }
  window.addEventListener('resize', setNavOffset);
  document.addEventListener('shown.bs.collapse', setNavOffset);
  document.addEventListener('hidden.bs.collapse', setNavOffset);

  function showLoading(){
    produkList.innerHTML =
      `<div class="col-12"><div class="loading"><div class="spinner"></div></div></div>`;
  }

  // =========================
  //  GROUPING: VARIAN -> PRODUK
  // =========================
  function buildGroups(){
    const map = new Map();

    produkVariants.forEach(v =>{
      const key = v.group || v.nama;
      let g = map.get(key);
      if(!g){
        g = {
          key,
          title: key,
          kategori: v.kategori,
          ikon: v.ikon,
          wa: v.wa || DEFAULT_WA,
          variants: [],
          minHarga: v.harga || 0,
          maxHargaLama: v.harga_lama || 0,
          available: Number(v.stok) > 0
        };
        map.set(key,g);
      }
      g.variants.push(v);
      if((v.harga || 0) < g.minHarga) g.minHarga = v.harga || 0;
      if((v.harga_lama || 0) > g.maxHargaLama) g.maxHargaLama = v.harga_lama || 0;
      if(Number(v.stok)>0) g.available = true;

      if(!g.ikon && v.ikon) g.ikon = v.ikon;
    });

    produkGroups = Array.from(map.values());
  }

  function applyFilterSort(){
    const q = (searchInput?.value || "").toLowerCase();

    viewData = produkGroups.filter(g=>{
      const inTitle    = (g.title || "").toLowerCase().includes(q);
      const inVariants = g.variants.some(v => (v.nama || "").toLowerCase().includes(q));
      return (inTitle || inVariants);
    });

    page = 1;
  }

  function waTextForGroup(group){
    return `Halo admin, saya tertarik dengan paket ${group.title}. Mohon informasi detail varian dan harga.`;
  }

  // =========================
  //  RENDER GRID PRODUK
  // =========================
  function renderProduk(append=false){
    const start = (page-1)*perPage;
    const slice = viewData.slice(start,start+perPage);

    if(!append) produkList.innerHTML="";

    if(slice.length===0 && !append){
      produkList.innerHTML=`
        <div class="col-12">
          <div class="empty-state">
            <i class="fas fa-search"></i>
            <h4>Produk tidak ditemukan</h4>
            <p>Coba ubah kata kunci pencarian.</p>
          </div>
        </div>`;
      btnLoadMore.style.display="none";
      return;
    }

    const wishlist = getStorage(WISH_KEY,[]);

    slice.forEach((group,idx)=>{
      const col=document.createElement("div");
      col.className="col-lg-3 col-md-4 col-sm-6 col-6";

      const catIconClass = categoryIconsFA[group.kategori] || "fa-box";
      const hasDiscount  = (group.maxHargaLama||0) > (group.minHarga||0);
      const stokOK       = !!group.available;
      const wished       = wishlist.includes(group.key);

      const waUrl = `https://wa.me/${encodeURIComponent(group.wa||DEFAULT_WA)}?text=${encodeURIComponent(waTextForGroup(group))}`;

      col.innerHTML=`
        <div class="card product-card fade-in"
             data-wa-url="${waUrl}"
             style="animation-delay:${idx*0.03}s">
          <button class="wishlist-btn ${wished?'active':''}" title="Favorit"
                  data-wish="${encodeURIComponent(group.key)}">
            <i class="fa-solid fa-heart"></i>
          </button>

          <div class="category-badge">
            <i class="fa-solid ${catIconClass}"></i>
            <span>${group.kategori || ''}</span>
          </div>

          <div class="card-body p-3 text-center">
            <div class="product-icon">
              <img src="${group.ikon||''}" alt="${group.title||''}"
                   onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjMTAxODI0IiBzdHJva2U9IiM0ODU2NjYiIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg=='">
            </div>

            <h6 class="product-title">${group.title||''}</h6>

            <div class="price-wrap">
              <span class="price">Mulai ${money(group.minHarga)}</span>
              ${hasDiscount?`<span class="price-old">${money(group.maxHargaLama)}</span>`:""}
            </div>

            <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
              <span class="badge ${stokOK?'bg-success-subtle text-success-emphasis':'bg-danger-subtle text-danger-emphasis'}">
                ${stokOK?'Tersedia':'Habis'}
              </span>
              <span class="badge bg-secondary-subtle text-secondary-emphasis">
                ${group.variants.length} varian
              </span>
            </div>

            <div class="product-actions d-flex w-100">
              <button class="btn-detail btn-detail-wide icon-btn" ${stokOK?'':'disabled'}
                      data-detail="${idx+start}" aria-label="Lihat varian">
                <i class="fa-solid fa-circle-info"></i>
                <span>Lihat Varian</span>
              </button>
            </div>
          </div>
        </div>`;

      produkList.appendChild(col);
    });

    btnLoadMore.style.display =
      (viewData.length > (start + slice.length)) ? "inline-block" : "none";
  }

  // =========================
  //  MODAL DETAIL
  // =========================
  const modalEl   = document.getElementById('produkModal');
  const bsModal   = new bootstrap.Modal(modalEl);
  const modalAddCart = document.getElementById('modalAddCart');
  const modalBody = document.getElementById('modalBody');
  let currentDetailIdx = null;

  function showDetailByGlobalIndex(globalIdx){
    const group = viewData[globalIdx];
    if(!group) return;

    currentDetailIdx = globalIdx;

    const catIconClass = categoryIconsFA[group.kategori] || "fa-box";
    const primaryVariant =
      group.variants.find(v => Number(v.stok)>0) || group.variants[0];

    const variantsHTML = group.variants.map((v,i)=>{
      const fitur = (v.deskripsi||[]).map(li =>
        `<li class="variant-feature-item">
          <i class="fas fa-check-circle variant-feature-icon me-2"></i>
          <span>${li}</span>
        </li>`
      ).join("");
      const stokOK = Number(v.stok)>0;

      return `
        <div class="variant-card mb-3">
          <div class="variant-card-header d-flex justify-content-between align-items-start mb-2">
            <div>
              <div class="variant-card-title fw-semibold">${v.nama}</div>
              <div class="variant-card-label small text-muted">Varian ${i+1}</div>
            </div>
            <div class="text-end">
              <div class="variant-card-price fw-bold">${money(v.harga)}</div>
              ${(v.harga_lama && v.harga_lama>v.harga)
                ? `<div class="variant-card-price-old small">${money(v.harga_lama)}</div>`
                : ""
              }
              <div class="mt-1">
                <span class="badge ${stokOK?'bg-success-subtle text-success-emphasis':'bg-danger-subtle text-danger-emphasis'}">
                  ${stokOK?'Tersedia':'Habis'}
                </span>
              </div>
            </div>
          </div>

          ${fitur ? `<ul class="variant-features list-unstyled mb-2">${fitur}</ul>` : ""}

          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-outline-primary"
                    data-add-variant="${encodeURIComponent(v.nama)}"
                    ${stokOK ? '' : 'disabled'}>
              <i class="fa-solid fa-cart-plus me-1"></i>Keranjang
            </button>
            <a href="https://wa.me/${encodeURIComponent(DEFAULT_WA)}?text=${
                encodeURIComponent(`Halo admin, saya ingin memesan ${v.nama} (${money(v.harga)}).`)
              }"
              target="_blank"
              class="btn btn-sm btn-success ${stokOK ? '' : 'disabled'}">
              <i class="fab fa-whatsapp me-1"></i>Pesan varian ini
            </a>
          </div>
        </div>`;
    }).join("");

    modalBody.innerHTML = `
      <div class="modal-product-main mb-3">
        <div class="row align-items-center g-3">
          <div class="col-md-4 text-center mb-2 mb-md-0">
            <div class="product-icon modal-product-icon mx-auto">
              <img src="${group.ikon || ''}" alt="${group.title || ''}"
                  style="width:60px;height:60px;"
                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHJ4PSIxMiIgZmlsbD0iIzIwMTgzMCIgc3Ryb2tlPSIjNjQ3NDhiIiBzdHJva2Utd2lkdGg9IjEiLz48L3N2Zz4='">
            </div>
            <span class="badge modal-category-pill mt-2 d-inline-flex align-items-center gap-1">
              <i class="fa-solid ${catIconClass}"></i>
              <span>${group.kategori || ''}</span>
            </span>
          </div>
          <div class="col-md-8">
            <h5 class="modal-product-title mb-1">${group.title || ''}</h5>
            <p class="modal-product-subtitle mb-2">
              Tersedia <strong>${group.variants.length} varian</strong> dengan harga mulai
              <strong>${money(group.minHarga)}</strong>.
            </p>
            <div class="modal-product-prices d-flex align-items-baseline gap-2">
              <span class="modal-price-main">${money(group.minHarga)}</span>
              ${(group.maxHargaLama && group.maxHargaLama>group.minHarga)
                ? `<span class="modal-price-old">${money(group.maxHargaLama)}</span>`
                : ""
              }
            </div>
          </div>
        </div>
      </div>

      <hr class="my-3">

      <div class="modal-variant-list">
        ${variantsHTML}
      </div>
    `;

    const modalPesanBtn = document.getElementById("modalPesanBtn");
    if(primaryVariant){
      modalPesanBtn.href =
        `https://wa.me/${encodeURIComponent(DEFAULT_WA)}?text=${
          encodeURIComponent(`Halo admin, saya ingin memesan ${primaryVariant.nama} (${money(primaryVariant.harga)}).`)
        }`;
      modalAddCart.disabled = !(Number(primaryVariant.stok)>0);
      modalAddCart.dataset.primaryVariant = primaryVariant.nama;
    }else{
      modalPesanBtn.href = "#";
      modalAddCart.disabled = true;
      delete modalAddCart.dataset.primaryVariant;
    }

    bsModal.show();
  }

  // swipe close modal di HP
  (function enableModalSwipeClose(){
    const content=document.getElementById('produkModalContent'); let startY=null;
    content.addEventListener('touchstart',e=>{startY=e.touches[0].clientY;},{passive:true});
    content.addEventListener('touchmove',e=>{
      if(startY===null)return;
      const dy=e.touches[0].clientY-startY;
      if(dy>80){startY=null; bsModal.hide();}
    }, {passive:true});
    content.addEventListener('touchend',()=>{startY=null;});
  })();

  modalBody.addEventListener('click',(e)=>{
    const btn = e.target.closest('[data-add-variant]');
    if(!btn) return;
    const namaVar = decodeURIComponent(btn.dataset.addVariant);
    addToCart(namaVar,1);
    new bootstrap.Offcanvas('#offcanvasCart').show();
  });

  // =========================
  //  KERANJANG
  // =========================
  function getCart(){return getStorage(CART_KEY,[]);}
  function setCart(c){setStorage(CART_KEY,c); updateCartUI();}
  function addToCart(name,qty=1){
    const item = produkVariants.find(p=>p.nama===name);
    if(!item || !(Number(item.stok)>0)) return;
    const cart = getCart();
    const ex   = cart.find(ci=>ci.nama===name);
    if(ex){ex.qty+=qty;}
    else{cart.push({nama:item.nama,harga:item.harga,wa:DEFAULT_WA,qty});}
    setCart(cart);
  }
  function removeFromCart(name){
    setCart(getCart().filter(ci=>ci.nama!==name));
  }
  function changeQty(name,delta){
    const cart=getCart();
    const it=cart.find(ci=>ci.nama===name);
    if(!it)return;
    it.qty=Math.max(1,(it.qty||1)+delta);
    setCart(cart);
  }
  function clearCart(){setCart([]);}

  function updateCartUI(){
    const cart = getCart();
    const totalQty = cart.reduce((a,b)=>a+(b.qty||1),0);
    document.getElementById("cartCount").textContent = totalQty;

    const wrap = document.getElementById("cartItems");
    if(cart.length===0){
      wrap.innerHTML = `
        <div class="empty-state">
          <i class="fa-regular fa-face-frown"></i>
          <p>Keranjang kosong</p>
        </div>`;
      document.getElementById("cartTotal").textContent = money(0);
      document.getElementById("btnCheckoutWA").href = "#";
      document.getElementById('navCartCount').textContent = 0;
      document.dispatchEvent(
        new CustomEvent('dnd:cart-updated',{detail:{count:0,total:0}})
      );
      return;
    }

    let total=0;
    wrap.innerHTML = cart.map(ci=>{
      const sub=(ci.harga||0)*(ci.qty||1); total+=sub;
      return `
        <div class="d-flex align-items-center justify-content-between border rounded-3 p-2 mb-2">
          <div>
            <div class="fw-bold">${ci.nama}</div>
            <div class="text-muted small">${money(ci.harga)} × ${ci.qty}</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary" data-qtyminus="${encodeURIComponent(ci.nama)}">-</button>
            <button class="btn btn-sm btn-outline-secondary" data-qtyplus="${encodeURIComponent(ci.nama)}">+</button>
            <button class="btn btn-sm btn-outline-danger" data-remove="${encodeURIComponent(ci.nama)}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>`;
    }).join("");

    document.getElementById("cartTotal").textContent = money(total);

    const lines = cart.map(ci=>`• ${ci.nama} x${ci.qty} = ${money(ci.harga*ci.qty)}`).join('\n');
    const text  =
      `Halo admin, saya ingin checkout layanan digital berikut:\n${lines}\n\nTotal: ${money(total)}\n\nTerima kasih.`;

    document.getElementById("btnCheckoutWA").href =
      `https://wa.me/${encodeURIComponent(DEFAULT_WA)}?text=${encodeURIComponent(text)}`;

    document.getElementById('navCartCount').textContent = totalQty;
    document.dispatchEvent(
      new CustomEvent('dnd:cart-updated',{detail:{count:totalQty,total}})
    );
  }

  // =========================
  //  EVENT LISTENER KERANJANG & GRID
  // =========================
  searchInput.addEventListener("input",()=>{
    applyFilterSort();
    renderProduk(false);
  });

  // klik kartu / tombol
  produkList.addEventListener("click",e=>{
    const t = e.target.closest("[data-detail],[data-add],[data-wish]");
    if(t){
      e.stopPropagation();

      if(t.dataset.detail!==undefined){
        showDetailByGlobalIndex(Number(t.dataset.detail));
        return;
      }else if(t.dataset.add){
        addToCart(decodeURIComponent(t.dataset.add),1);
        return;
      }else if(t.dataset.wish){
        toggleWishlist(decodeURIComponent(t.dataset.wish));
        t.classList.toggle('active');
        return;
      }
    }

    // klik area kartu => WA
    const card = e.target.closest(".product-card");
    if(!card) return;

    const url = card.getAttribute("data-wa-url");
    if(url) window.open(url, "_blank");
  });

  document.getElementById("cartItems").addEventListener("click",e=>{
    const t=e.target.closest("[data-qtyminus],[data-qtyplus],[data-remove]");
    if(!t)return;
    if(t.dataset.qtyminus){
      changeQty(decodeURIComponent(t.dataset.qtyminus),-1);
    }else if(t.dataset.qtyplus){
      changeQty(decodeURIComponent(t.dataset.qtyplus),+1);
    }else if(t.dataset.remove){
      removeFromCart(decodeURIComponent(t.dataset.remove));
    }
  });

  document.getElementById("btnClearCart").addEventListener("click",()=>clearCart());
  document.getElementById("btnLoadMore").addEventListener("click",()=>{
    page+=1;
    renderProduk(true);
  });

  document.getElementById("modalAddCart").addEventListener("click",()=>{
    const primaryName = document.getElementById("modalAddCart").dataset.primaryVariant;
    if(!primaryName) return;
    addToCart(primaryName,1);
    new bootstrap.Offcanvas('#offcanvasCart').show();
  });

  function toggleWishlist(key){
    const list=getStorage(WISH_KEY,[]);
    const i=list.indexOf(key);
    if(i>-1) list.splice(i,1);
    else list.push(key);
    setStorage(WISH_KEY,list);
  }

  // =========================
  //  DARK MODE
  // =========================
  (function initTheme(){
    const saved = localStorage.getItem("dnd_theme") || "dark";
    document.documentElement.setAttribute("data-theme",saved);
    const darkBtn = document.getElementById("floatingDarkBtn");
    const setIcon = ()=>{
      darkBtn.innerHTML =
        `<i class="fa-solid ${document.documentElement.getAttribute('data-theme')==='dark'?'fa-sun':'fa-moon'}"></i>`;
    };
    setIcon();
    darkBtn.addEventListener("click",()=>{
      const mode = document.documentElement.getAttribute("data-theme")==="dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme",mode);
      localStorage.setItem("dnd_theme",mode);
      setIcon();
      const navBtn=document.getElementById('navDarkBtn');
      if(navBtn){ navBtn.innerHTML = darkBtn.innerHTML; }
    });
  })();

  (function initNavbarSearch(){
    const searchBtns   = document.querySelectorAll('[data-nav-search]');
    const searchOverlay= document.getElementById('searchOverlay');
    const btnCloseSearch = document.getElementById('btnCloseSearch');

    if(!searchBtns.length || !searchOverlay || !searchInput) return;

    function openSearch(){
      searchOverlay.classList.add('open');
      const produkSection = document.getElementById('listProduk');
      if (produkSection) {
        produkSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      setTimeout(() => searchInput.focus(), 120);
    }

    function closeSearch(){
      searchOverlay.classList.remove('open');
      searchInput.blur();
    }

    function toggleSearch(){
      if (searchOverlay.classList.contains('open')) closeSearch();
      else openSearch();
    }

    searchBtns.forEach(btn => {
      btn.addEventListener('click', toggleSearch);
    });

    if (btnCloseSearch) {
      btnCloseSearch.addEventListener('click', closeSearch);
    }

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') closeSearch();
    });
  })();

  document.addEventListener('click',(e)=>{
    const a=e.target.closest('a[data-scroll][href^="#"]');
    if(!a) return;
    e.preventDefault();
    const sel=a.getAttribute('href');
    const el=document.querySelector(sel);
    if(el) el.scrollIntoView({behavior:'smooth'});
    const coll=document.getElementById('mainNav');
    if(coll && coll.classList.contains('show')) new bootstrap.Collapse(coll).hide();
  });

  (function hookNavbarDark(){
    const btn = document.getElementById('navDarkBtn');
    if(!btn) return;
    const setIcon=()=>{
      btn.innerHTML =
        `<i class="fa-solid ${document.documentElement.getAttribute('data-theme')==='dark'?'fa-sun':'fa-moon'}"></i>`;
    };
    setIcon();
    btn.addEventListener('click', ()=>{
      const mode=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-theme',mode);
      localStorage.setItem('dnd_theme',mode);
      setIcon();
      const floatingBtn = document.getElementById('floatingDarkBtn');
      if(floatingBtn) floatingBtn.innerHTML = btn.innerHTML;
    });
  })();

  (function syncCartCountToNav(){
    const navCount = document.getElementById('navCartCount');
    if(!navCount) return;
    document.addEventListener('dnd:cart-updated',(e)=>{
      if(typeof e.detail?.count === 'number') navCount.textContent = e.detail.count;
    });
    const initCart = getStorage(CART_KEY,[]);
    navCount.textContent = initCart.reduce((a,b)=>a+(b.qty||1),0);
  })();

  // =========================
  //  INIT TANPA GOOGLE SHEET
  // =========================
  function initProdukStatic(){
    showLoading();
    // copy data statis ke produkVariants
    produkVariants = STATIC_VARIANTS.slice();
    buildGroups();
    applyFilterSort();
    renderProduk(false);
    document.body.classList.add('loaded');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    setNavOffset();
    initProdukStatic();
    updateCartUI();
    const fy = document.getElementById('footerYear');
    if(fy){ fy.textContent = new Date().getFullYear(); }
  });

  window.addEventListener('load',()=>document.body.classList.add('loaded'));
</script>

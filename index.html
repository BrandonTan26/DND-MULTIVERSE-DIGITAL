<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D&D Multiverse Digital — Price List</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --bg0:#05060a;
      --bg1:#070b14;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.10);
      --text:#e7eaf3;
      --muted:#a3aac2;

      --neon1:#7c3aed;
      --neon2:#22d3ee;
      --neon3:#34d399;
      --warn:#fbbf24;

      --radius:18px;
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --shadow2: 0 26px 70px rgba(0,0,0,.60);

      --nav-h: 70px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(124,58,237,.25), transparent 60%),
        radial-gradient(700px 420px at 85% 22%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(800px 520px at 55% 90%, rgba(52,211,153,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* starfield (simple) */
    .stars:before, .stars:after{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.55) 50%, transparent 55%),
        radial-gradient(1px 1px at 35% 70%, rgba(255,255,255,.35) 50%, transparent 55%),
        radial-gradient(1px 1px at 80% 35%, rgba(255,255,255,.40) 50%, transparent 55%),
        radial-gradient(1px 1px at 55% 25%, rgba(255,255,255,.25) 50%, transparent 55%),
        radial-gradient(1px 1px at 60% 80%, rgba(255,255,255,.25) 50%, transparent 55%),
        radial-gradient(2px 2px at 20% 85%, rgba(255,255,255,.18) 50%, transparent 55%);
      opacity:.35;
      pointer-events:none;
      z-index:-1;
    }
    .stars:after{
      opacity:.18;
      filter: blur(.4px);
      transform: scale(1.02);
    }

    /* NAV */
    .nav-glass{
      position:sticky; top:0; z-index:1100;
      backdrop-filter: blur(12px) saturate(1.1);
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-bottom:1px solid var(--stroke);
    }
    .brand{
      display:flex; align-items:center; gap:.75rem;
      font-weight:900;
      letter-spacing:.2px;
      text-decoration:none;
      color:var(--text);
    }
    .brand-badge{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(124,58,237,.35), rgba(34,211,238,.22));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 30px rgba(124,58,237,.18);
    }
    .brand-title{
      line-height:1.05;
      margin:0;
      font-size:1.05rem;
    }
    .brand-sub{
      margin:0;
      font-size:.82rem;
      color:var(--muted);
      font-weight:700;
    }
    .nav-btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 999px;
      padding:.55rem .85rem;
      font-weight:900;
      transition:.18s ease;
      display:inline-flex; align-items:center; gap:.5rem;
      text-decoration:none;
      white-space:nowrap;
    }
    .nav-btn:hover{transform: translateY(-1px); box-shadow: 0 14px 30px rgba(0,0,0,.45); color:var(--text)}
    .nav-btn.primary{
      border:0;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.85));
    }

    /* HERO */
    .hero{
      padding: 2.4rem 0 1.2rem;
    }
    .hero-card{
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero-card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 220px at 20% 10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(520px 240px at 80% 20%, rgba(34,211,238,.22), transparent 60%);
      opacity:.85;
      pointer-events:none;
    }
    .hero-inner{position:relative; padding: 1.3rem 1.2rem;}
    @media(min-width:768px){ .hero-inner{padding: 1.8rem 1.8rem;} }

    .pill{
      display:inline-flex; align-items:center; gap:.5rem;
      border-radius:999px;
      padding:.35rem .75rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      font-weight:900;
      color:#eaf2ff;
      font-size:.86rem;
    }
    .hero h1{
      margin:.75rem 0 .5rem;
      font-weight:1000;
      letter-spacing:-.02em;
      line-height:1.1;
      font-size: clamp(1.65rem, 4vw, 2.6rem);
    }
    .hero p{
      margin:0;
      color:var(--muted);
      max-width: 60ch;
      font-weight:700;
    }
    .hero-actions{display:flex; flex-wrap:wrap; gap:.75rem; margin-top: 1rem;}
    .hero-stats{
      margin-top: 1rem;
      display:grid;
      grid-template-columns: 1fr;
      gap:.75rem;
    }
    @media(min-width:768px){ .hero-stats{grid-template-columns: repeat(3, 1fr);} }
    .stat{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: .85rem .95rem;
      display:flex; gap:.75rem; align-items:center;
    }
    .stat .ico{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .stat .k{font-weight:1000}
    .stat .v{color:var(--muted); font-weight:800; font-size:.88rem}

    /* TOOLS */
    .tools{
      position:sticky;
      top: var(--nav-h);
      z-index: 1000;
      padding: .85rem 0;
      backdrop-filter: blur(12px) saturate(1.1);
      background: linear-gradient(180deg, rgba(5,6,10,.75), rgba(5,6,10,.35));
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .tool-card{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding: .85rem;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
    }
    .control{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: .85rem .95rem;
      font-weight:800;
    }
    .control::placeholder{color: rgba(231,234,243,.55)}
    .control:focus{
      outline:none;
      box-shadow: 0 0 0 4px rgba(34,211,238,.12);
      border-color: rgba(34,211,238,.30);
    }
    .search-wrap{position:relative}
    .search-ico{
      position:absolute; left:14px; top:50%;
      transform: translateY(-50%);
      color: rgba(231,234,243,.60);
      pointer-events:none;
    }
    .search-input{padding-left: 2.75rem;}

    /* GRID */
    .section{
      padding: 1.35rem 0 2.2rem;
    }
    .section-head{
      text-align:center;
      margin-bottom: 1.0rem;
    }
    .section-title{
      font-weight:1000;
      letter-spacing:-.02em;
      margin:0 0 .25rem;
      font-size: 1.65rem;
    }
    .section-sub{
      margin:0 auto;
      max-width: 70ch;
      color: var(--muted);
      font-weight:800;
      font-size:.95rem;
    }

    .grid{
      display:grid;
      gap: 1rem;
      grid-template-columns: repeat(12, 1fr);
    }
    .grid-item{ grid-column: span 12; }
    @media(min-width:576px){ .grid-item{ grid-column: span 6; } }
    @media(min-width:992px){ .grid-item{ grid-column: span 4; } }
    @media(min-width:1200px){ .grid-item{ grid-column: span 3; } }

    .pcard{
      height:100%;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      overflow:hidden;
      cursor:pointer;
      transition: .18s ease;
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .pcard:hover{
      transform: translateY(-3px);
      box-shadow: var(--shadow2);
      border-color: rgba(34,211,238,.25);
    }
    .pcard:before{
      content:"";
      position:absolute; left:0; top:0; right:0; height:3px;
      background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(34,211,238,.85), rgba(52,211,153,.70));
      opacity:.9;
    }

    .phead{
      padding: 1rem 1rem .65rem;
      display:flex;
      align-items:flex-start;
      gap:.85rem;
    }
    .plogo{
      width:56px;height:56px;border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      display:grid;place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .plogo img{
      width:36px;height:36px;
      object-fit:contain;
      filter: drop-shadow(0 10px 24px rgba(0,0,0,.45));
    }

    .pchip{
      display:inline-flex; align-items:center; gap:.45rem;
      font-weight:950;
      font-size:.78rem;
      padding:.35rem .6rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: rgba(231,234,243,.92);
      white-space:nowrap;
    }
    .pchip i{color: rgba(34,211,238,.95)}

    .ptitle{
      margin:.35rem 0 .2rem;
      font-weight:1000;
      letter-spacing:-.01em;
      line-height:1.25;
      font-size: 1.02rem;
      min-height: 2.5em;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .pmeta{
      color: var(--muted);
      font-weight:850;
      font-size:.86rem;
      display:flex;
      flex-wrap:wrap;
      gap:.45rem;
      align-items:center;
    }
    .dot{width:4px;height:4px;border-radius:999px;background: rgba(231,234,243,.25); display:inline-block}

    .pbody{padding: 0 1rem 1rem; margin-top:auto;}
    .price-row{
      border-top: 1px dashed rgba(255,255,255,.14);
      padding-top:.75rem;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:.75rem;
    }
    .pprice{
      font-weight:1100;
      font-size:1.12rem;
      line-height:1.1;
      letter-spacing:-.01em;
      background: linear-gradient(135deg, rgba(34,211,238,1), rgba(124,58,237,1));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .pold{
      margin-top:.15rem;
      font-weight:900;
      font-size:.82rem;
      color: rgba(231,234,243,.45);
      text-decoration: line-through;
    }
    .pcta{
      margin-top:.85rem;
      display:flex;
      gap:.6rem;
    }
    .btnx{
      flex:1;
      border-radius: 14px;
      padding:.72rem .9rem;
      font-weight:950;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      text-decoration:none;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      gap:.45rem;
      transition:.18s ease;
      user-select:none;
    }
    .btnx:hover{transform: translateY(-1px); color:var(--text); box-shadow: 0 16px 34px rgba(0,0,0,.45)}
    .btnx.primary{
      border:0;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.85));
    }
    .btnx.wa{
      border:0;
      background: linear-gradient(135deg, rgba(52,211,153,.95), rgba(34,211,238,.75));
    }

    /* states */
    .state{
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding: 1.2rem;
      text-align:center;
      color: var(--muted);
      font-weight:850;
      box-shadow: var(--shadow);
    }
    .spinner{
      width:38px;height:38px;border-radius:999px;
      border:4px solid rgba(255,255,255,.14);
      border-top-color: rgba(34,211,238,.95);
      margin: 0 auto .85rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* modal */
    .modal-content{
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(10,12,20,.96), rgba(10,12,20,.92));
      color: var(--text);
      box-shadow: 0 30px 90px rgba(0,0,0,.75);
    }
    .modal-header{
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg, rgba(124,58,237,.25), rgba(34,211,238,.12));
    }
    .modal-title{font-weight:1000; letter-spacing:-.01em}
    .modal-body{max-height: 70vh; overflow:auto}
    .modal-footer{border-top:1px solid rgba(255,255,255,.10)}
    .variant{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: .95rem;
      margin-bottom: .85rem;
    }
    .vtop{display:flex; gap:.75rem; justify-content:space-between; align-items:flex-start}
    .vname{margin:0; font-weight:1000; letter-spacing:-.01em}
    .vdesc{margin:.35rem 0 .65rem; color: var(--muted); font-weight:850}
    .vfoot{
      border-top:1px dashed rgba(255,255,255,.12);
      padding-top:.75rem;
      display:flex; gap:.75rem; justify-content:space-between; align-items:center; flex-wrap:wrap;
    }
    .vprice{
      font-weight:1100;
      font-size:1.1rem;
      background: linear-gradient(135deg, rgba(34,211,238,1), rgba(124,58,237,1));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .vold{
      display:block;
      margin-top:.15rem;
      font-weight:900;
      font-size:.82rem;
      color: rgba(231,234,243,.45);
      text-decoration: line-through;
    }
    .vtag{
      border-radius:999px;
      padding:.28rem .6rem;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      font-weight:950;
      font-size:.78rem;
      white-space:nowrap;
    }

    /* footer */
    footer{
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 1.25rem 0 2rem;
      color: rgba(231,234,243,.75);
      font-weight:850;
    }
    .tiny{color: rgba(231,234,243,.55); font-size:.9rem; font-weight:800}
  </style>
</head>

<body class="stars">
  <nav class="nav-glass" id="mainNavbar">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between py-2">
        <a class="brand" href="#">
          <div class="brand-badge"><i class="fa-solid fa-infinity"></i></div>
          <div>
            <p class="brand-title mb-0">D&D MULTIVERSE DIGITAL</p>
            <p class="brand-sub mb-0">Space Neon • Produk Digital • Reseller Price</p>
          </div>
        </a>

        <div class="d-flex align-items-center gap-2">
          <a class="nav-btn" href="#produk"><i class="fa-solid fa-tags"></i> Produk</a>
          <a class="nav-btn primary" id="btnChatTop" target="_blank" rel="noopener">
            <i class="fa-brands fa-whatsapp"></i> WA Admin
          </a>
        </div>
      </div>
    </div>
  </nav>

  <section class="hero">
    <div class="container">
      <div class="hero-card">
        <div class="hero-inner">
          <div class="pill">
            <i class="fa-solid fa-shield-halved"></i>
            <span>Harga reseller + proses cepat (via WhatsApp)</span>
          </div>

          <h1>Semua Produk Digital Lu Kumpulin Jadi 1 Toko.</h1>
          <p>
            Cari produk → klik card → pilih varian → langsung pesan ke WA Admin.
            <br/>Harga yang tampil sudah <b>markup +Rp8.000</b> (kecuali kalau sheet lu udah punya kolom harga_reseller).
          </p>

          <div class="hero-actions">
            <a class="nav-btn primary" href="#produk"><i class="fa-solid fa-rocket"></i> Lihat Produk</a>
            <a class="nav-btn" id="btnChatHero" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> Chat Admin</a>
          </div>

          <div class="hero-stats">
            <div class="stat">
              <div class="ico"><i class="fa-solid fa-bolt"></i></div>
              <div>
                <div class="k">Fast Flow</div>
                <div class="v">Klik → pilih varian → WA</div>
              </div>
            </div>
            <div class="stat">
              <div class="ico"><i class="fa-solid fa-layer-group"></i></div>
              <div>
                <div class="k">Rapi & Simetris</div>
                <div class="v">Grid konsisten semua device</div>
              </div>
            </div>
            <div class="stat">
              <div class="ico"><i class="fa-solid fa-image"></i></div>
              <div>
                <div class="k">Ada Foto</div>
                <div class="v">Icon per produk (fallback auto)</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <section class="tools" id="toolsBar">
    <div class="container">
      <div class="tool-card">
        <div class="row g-2 align-items-center">
          <div class="col-md-7">
            <div class="search-wrap">
              <i class="fa-solid fa-magnifying-glass search-ico"></i>
              <input id="searchInput" class="form-control control search-input" type="text"
                placeholder="Cari: Netflix / Spotify / Canva / TikTok / Instagram / dll...">
            </div>
          </div>
          <div class="col-md-5">
            <select id="filterKategori" class="form-select control">
              <option value="">Semua Kategori</option>
            </select>
          </div>
        </div>
        <div class="tiny mt-2">
          Sumber data: Google Sheet lu. Kalau produk gak kebaca: pastiin share “Anyone with link = Viewer”.
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="produk">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title">All Products</h2>
        <p class="section-sub">
          Klik produk untuk buka varian. Harga tampil = <b>harga reseller</b> (kalau ada) atau <b>harga + markup</b>.
        </p>
      </div>

      <div id="produkList">
        <div class="state">
          <div class="spinner"></div>
          Memuat produk dari Google Sheet...
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="container">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>© <span id="yearNow"></span> D&D MULTIVERSE DIGITAL</div>
        <div>Crafted with ❤️ By Brandon Tan</div>
      </div>
    </div>
  </footer>

  <!-- Modal -->
  <div class="modal fade" id="groupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" style="max-width:760px;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="groupModalLabel"><i class="fa-solid fa-layer-group me-2"></i>Detail Produk</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body" id="groupModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // =========================
    // CONFIG (tinggal edit ini)
    // =========================
    const STORE_NAME = "D&D MULTIVERSE DIGITAL";
    const WA_LOCAL   = "087809236556"; // format indo (0xxxx) OK
    const WA_ADMIN   = normalizeWA(WA_LOCAL); // jadi 62xxxx

    const MARKUP_RP  = 8000;

    const SHEET_ID   = "10E8yNqPCGdlnmQKbVjqSS24_clFGdF6EBhALS5S1d4E";
    const SHEET_NAME = "Produk"; // kalau tab lu beda, ganti: misal "Produk Web"
    const SHEET_JSON_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    // Column mapping (berdasarkan format yang paling umum dari source lu)
    // 0 nama | 1 harga | 2 ikon | 3 deskripsi (||) | 4 kategori | 5 wa | 6 harga_lama | 7 stok | 8 kode | 9 group | 10 harga_reseller (opsional)
    const COL = {
      nama: 0, harga: 1, ikon: 2, deskripsi: 3, kategori: 4, wa: 5,
      hargaLama: 6, stok: 7, kode: 8, group: 9, hargaReseller: 10
    };

    // =========================
    // STATE
    // =========================
    let rows = [];         // varian list
    let groupIndex = {};   // groupName -> { items, kategori, ikon, hargaMin, hargaMax }
    let groupOrder = [];   // urutan group sesuai sheet
    let kategoriSet = new Set();

    const produkListEl  = document.getElementById("produkList");
    const searchInputEl = document.getElementById("searchInput");
    const filterKatEl   = document.getElementById("filterKategori");

    const categoryIcons = {
      "Langganan": "fa-bell",
      "Streaming": "fa-tv",
      "Penyimpanan": "fa-hard-drive",
      "Software": "fa-puzzle-piece",
      "Desain": "fa-palette",
      "Produktivitas": "fa-list-check",
      "AI Tools": "fa-robot",
      "Keamanan": "fa-shield-halved",
      "Game": "fa-gamepad",
      "Voucher": "fa-gift",
      "Instagram": "fa-brands fa-instagram",
      "TikTok": "fa-brands fa-tiktok",
      "Website": "fa-globe"
    };

    // =========================
    // HELPERS
    // =========================
    function normalizeWA(raw){
      const s = String(raw || "").replace(/\D/g,"");
      if (!s) return "62";
      if (s.startsWith("62")) return s;
      if (s.startsWith("0")) return "62" + s.slice(1);
      return "62" + s;
    }

    function money(n){
      const v = Number(n || 0);
      return "Rp" + v.toLocaleString("id-ID");
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setNavHeightVar(){
      const nav = document.getElementById("mainNavbar");
      const h = nav ? nav.offsetHeight : 70;
      document.documentElement.style.setProperty("--nav-h", h + "px");
    }

    function waUrl(text){
      return `https://wa.me/${encodeURIComponent(WA_ADMIN)}?text=${encodeURIComponent(text)}`;
    }

    function showState(kind, msg, extra){
      const icon =
        kind === "loading" ? "" :
        kind === "error"   ? `<i class="fa-solid fa-triangle-exclamation me-2"></i>` :
                             `<i class="fa-solid fa-magnifying-glass me-2"></i>`;
      const spinner = kind === "loading" ? `<div class="spinner"></div>` : "";
      const extraHtml = extra ? `<div class="tiny mt-2">${extra}</div>` : "";
      produkListEl.innerHTML = `
        <div class="state">
          ${spinner}
          <div style="font-weight:1000;color:rgba(231,234,243,.92)">${icon}${escapeHtml(msg)}</div>
          ${extraHtml}
        </div>
      `;
    }

    // Build groups in sheet order (biar konsisten & nggak random)
    function buildGroups(items){
      const grouped = {};
      const order = [];

      items.forEach(it => {
        const g = (it.group && String(it.group).trim()) ? String(it.group).trim() : String(it.nama || "").trim();
        const groupName = g || "Tanpa Nama";

        if (!grouped[groupName]){
          grouped[groupName] = [];
          order.push(groupName);
        }
        grouped[groupName].push(it);
      });

      const idx = {};
      order.forEach(groupName => {
        const list = grouped[groupName];
        const kategori = list[0]?.kategori || "Umum";
        const ikon = list[0]?.ikon || "";
        const hargaMin = Math.min(...list.map(x => Number(x.harga_display || 0)));
        const hargaMax = Math.max(...list.map(x => Number(x.harga_display || 0)));
        idx[groupName] = { items: list, kategori, ikon, hargaMin, hargaMax };
      });

      return { idx, order };
    }

    function getFiltered(){
      const q = (searchInputEl.value || "").toLowerCase().trim();
      const kat = (filterKatEl.value || "");

      return rows.filter(r => {
        const matchQ =
          !q ||
          (r.nama || "").toLowerCase().includes(q) ||
          (r.group || "").toLowerCase().includes(q) ||
          (r.kategori || "").toLowerCase().includes(q) ||
          (r.deskripsiText || "").toLowerCase().includes(q);

        const matchKat = !kat || (r.kategori || "") === kat;
        return matchQ && matchKat;
      });
    }

    // =========================
    // RENDER
    // =========================
    function render(){
      const items = getFiltered();
      if (!items.length){
        showState("empty", "Produk tidak ditemukan", "Coba ganti keyword atau kategori lain.");
        return;
      }

      const built = buildGroups(items);
      groupIndex = built.idx;
      groupOrder = built.order;

      let html = `<div class="grid">`;

      groupOrder.forEach((gName) => {
        const g = groupIndex[gName];
        const catIcon = categoryIcons[g.kategori] || "fa-box";
        const count = g.items.length;

        const priceText = (g.hargaMin === g.hargaMax)
          ? money(g.hargaMin)
          : `${money(g.hargaMin)} — ${money(g.hargaMax)}`;

        const safeName = gName.replace(/'/g, "\\'");

        html += `
          <div class="grid-item">
            <div class="pcard" onclick="openGroup('${safeName}')">
              <div class="phead">
                <div class="plogo">
                  <img src="${escapeHtml(g.ikon)}" alt="${escapeHtml(gName)}"
                       onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHJ4PSIyMCIgZmlsbD0iIzBhMGIxMiIvPjxyZWN0IHg9IjgiIHk9IjgiIHdpZHRoPSI1NiIgaGVpZ2h0PSI1NiIgcng9IjE4IiBmaWxsPSIjMTExODI3IiBzdHJva2U9IiMyMzM0NTAiLz48cGF0aCBkPSJNMjQgNDJsMTItMjQgMTIgMjQiIHN0cm9rZT0iIzIyZDNlZSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNMjQgNDJoMjQiIHN0cm9rZT0iIzdhM2FlZCIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=';">
                </div>
                <div style="flex:1">
                  <div class="pchip">
                    <i class="fa-solid ${catIcon}"></i>
                    <span>${escapeHtml(g.kategori || "Umum")}</span>
                    <span style="opacity:.5">•</span>
                    <span>${count} varian</span>
                  </div>
                  <div class="ptitle">${escapeHtml(gName)}</div>
                  <div class="pmeta">
                    <span><i class="fa-solid fa-bolt" style="color:rgba(34,211,238,.95)"></i> Ready</span>
                    <span class="dot"></span>
                    <span>Click untuk detail</span>
                  </div>
                </div>
              </div>

              <div class="pbody">
                <div class="price-row">
                  <div>
                    <div class="pprice">${priceText}</div>
                    <div class="tiny">Harga reseller (markup aktif)</div>
                  </div>
                </div>

                <div class="pcta">
                  <div class="btnx primary" onclick="openGroup('${safeName}'); event.stopPropagation();">
                    <i class="fa-solid fa-circle-info"></i> Detail
                  </div>
                  <a class="btnx wa" href="${waUrl(`Halo admin, saya mau tanya produk: ${gName}`)}"
                     target="_blank" rel="noopener" onclick="event.stopPropagation();">
                    <i class="fa-brands fa-whatsapp"></i> WA
                  </a>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      html += `</div>`;
      produkListEl.innerHTML = html;
    }

    // =========================
    // MODAL
    // =========================
    function openGroup(groupName){
      const g = groupIndex[groupName];
      if (!g) return;

      const items = g.items; // urutan sesuai sheet
      const catIcon = categoryIcons[g.kategori] || "fa-box";

      let body = `
        <div class="mb-3" style="border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:1rem;">
          <div class="d-flex align-items-center gap-3">
            <div class="plogo" style="width:62px;height:62px;">
              <img src="${escapeHtml(g.ikon)}" alt="${escapeHtml(groupName)}"
                   onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHJ4PSIyMCIgZmlsbD0iIzBhMGIxMiIvPjxyZWN0IHg9IjgiIHk9IjgiIHdpZHRoPSI1NiIgaGVpZ2h0PSI1NiIgcng9IjE4IiBmaWxsPSIjMTExODI3IiBzdHJva2U9IiMyMzM0NTAiLz48cGF0aCBkPSJNMjQgNDJsMTItMjQgMTIgMjQiIHN0cm9rZT0iIzIyZDNlZSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNMjQgNDJoMjQiIHN0cm9rZT0iIzdhM2FlZCIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=';">
            </div>
            <div style="flex:1">
              <div class="pchip mb-2" style="display:inline-flex">
                <i class="fa-solid ${catIcon}"></i>
                <span>${escapeHtml(g.kategori || "Umum")}</span>
                <span style="opacity:.5">•</span>
                <span>${items.length} varian</span>
              </div>
              <div style="font-weight:1000;font-size:1.15rem;letter-spacing:-.01em">${escapeHtml(groupName)}</div>
              <div class="tiny">Pilih varian → klik Pesan → langsung ke WhatsApp Admin</div>
            </div>
          </div>
        </div>
      `;

      items.forEach((it, i) => {
        const desc = (it.deskripsi && it.deskripsi.length)
          ? it.deskripsi.slice(0, 6).map(d => `• ${escapeHtml(d)}`).join("<br>")
          : `<span class="tiny">Deskripsi belum diisi</span>`;

        const displayHarga = Number(it.harga_display || 0);
        const oldHarga = Number(it.harga_old || it.harga || 0);

        const resellerTag = (it.harga_reseller !== null && it.harga_reseller !== undefined && it.harga_reseller !== "")
          ? `<span class="vtag"><i class="fa-solid fa-star me-1" style="color:var(--warn)"></i>Reseller</span>`
          : `<span class="vtag"><i class="fa-solid fa-plus me-1" style="color:rgba(34,211,238,.95)"></i>Markup +${money(MARKUP_RP)}</span>`;

        const waTarget = normalizeWA(it.wa || WA_ADMIN);
        const pesan = `Halo admin, saya ingin pesan: ${it.nama} (${money(displayHarga)}).`;
        const link = `https://wa.me/${encodeURIComponent(waTarget)}?text=${encodeURIComponent(pesan)}`;

        body += `
          <div class="variant">
            <div class="vtop">
              <div>
                <p class="vname">${escapeHtml(it.nama || groupName)}</p>
                <div class="vdesc">${desc}</div>
              </div>
              ${resellerTag}
            </div>

            <div class="vfoot">
              <div>
                <div class="vprice">${money(displayHarga)}</div>
                ${oldHarga && oldHarga !== displayHarga ? `<span class="vold">${money(oldHarga)}</span>` : ``}
              </div>
              <a class="btnx wa" href="${link}" target="_blank" rel="noopener" style="flex:0 0 auto;">
                <i class="fa-brands fa-whatsapp"></i> Pesan
              </a>
            </div>
          </div>
        `;
      });

      document.getElementById("groupModalLabel").innerHTML =
        `<i class="fa-solid fa-layer-group me-2"></i> ${escapeHtml(groupName)}`;
      document.getElementById("groupModalBody").innerHTML = body;

      new bootstrap.Modal(document.getElementById("groupModal")).show();
    }

    // expose for onclick
    window.openGroup = openGroup;

    // =========================
    // LOAD SHEET
    // =========================
    async function loadSheet(){
      showState("loading", "Memuat produk...", "Kalau error: cek nama tab & share sheet viewer.");
      try{
        const res  = await fetch(SHEET_JSON_URL, { cache: "no-store" });
        const text = await res.text();
        const json = JSON.parse(text.substring(47, text.length - 2));
        const rawRows = json.table.rows || [];

        rows = rawRows.map((r, idx) => {
          const c = r.c || [];
          const nama = c[COL.nama]?.v ?? "";
          if (!String(nama).trim()) return null;

          const harga = Number(c[COL.harga]?.v ?? 0) || 0;
          const ikon  = c[COL.ikon]?.v ?? "";
          const deskripsiStr = (c[COL.deskripsi]?.v ?? "").toString();
          const deskripsi = deskripsiStr.split("||").map(s => s.trim()).filter(Boolean);
          const kategori = c[COL.kategori]?.v ?? "Umum";
          const wa = c[COL.wa]?.v ?? WA_ADMIN;
          const group = c[COL.group]?.v ?? "";

          const hargaLama = Number(c[COL.hargaLama]?.v ?? 0) || 0;

          const hargaResRaw = c[COL.hargaReseller]?.v;
          const harga_reseller = (hargaResRaw === undefined || hargaResRaw === null || hargaResRaw === "")
            ? null
            : (Number(hargaResRaw) || null);

          // display price rule:
          // - kalau ada harga_reseller -> pake itu
          // - kalau enggak -> harga + markup
          const harga_display = (harga_reseller !== null && !isNaN(harga_reseller))
            ? harga_reseller
            : (harga + MARKUP_RP);

          kategoriSet.add(kategori);

          return {
            idx,
            nama: String(nama),
            harga,
            harga_old: hargaLama || harga,
            harga_reseller,
            harga_display,
            ikon: String(ikon),
            deskripsi,
            deskripsiText: deskripsi.join(" "),
            kategori: String(kategori),
            wa: String(wa),
            group: String(group)
          };
        }).filter(Boolean);

        if (!rows.length){
          showState("error", "Sheet kebaca tapi kosong", "Isi minimal kolom Nama & Harga di tab Produk.");
          return;
        }

        // build category dropdown
        const cats = Array.from(kategoriSet).sort((a,b)=>a.localeCompare(b));
        filterKatEl.innerHTML = `<option value="">Semua Kategori</option>` + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

        render();
      }catch(err){
        console.error(err);
        showState(
          "error",
          "Gagal memuat produk dari Google Sheet",
          `Cek: (1) Nama tab = "${SHEET_NAME}" (2) Share = Viewer publik (3) Link gviz bisa diakses.<br><span class="tiny">${escapeHtml(String(err))}</span>`
        );
      }
    }

    // =========================
    // INIT
    // =========================
    document.getElementById("yearNow").textContent = new Date().getFullYear();

    function bindWAButtons(){
      const link = waUrl("Halo admin, saya mau tanya produk di D&D Multiverse Digital.");
      document.getElementById("btnChatTop").href = link;
      document.getElementById("btnChatHero").href = link;
    }

    window.addEventListener("resize", setNavHeightVar);
    window.addEventListener("orientationchange", setNavHeightVar);

    searchInputEl.addEventListener("input", () => render());
    filterKatEl.addEventListener("change", () => render());

    document.addEventListener("DOMContentLoaded", () => {
      setNavHeightVar();
      bindWAButtons();
      loadSheet();
    });
  </script>
</body>
</html>
